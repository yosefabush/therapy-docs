---
phase: 04-patient-insight-engine
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/ai/patient-insights/prompts.ts
  - src/lib/ai/patient-insights/generator.ts
  - src/lib/ai/patient-insights/index.ts
autonomous: true

must_haves:
  truths:
    - "AI prompt exists for cross-session insight analysis"
    - "Generator produces PatientInsights with 4 categories"
    - "Generator supports both mock and real AI modes"
    - "Each insight category has appropriate content"
  artifacts:
    - path: "src/lib/ai/patient-insights/prompts.ts"
      provides: "Patient insight system and user prompt templates"
      exports: ["PATIENT_INSIGHT_SYSTEM_PROMPT", "buildInsightUserPrompt"]
    - path: "src/lib/ai/patient-insights/generator.ts"
      provides: "AI-powered insight generation"
      exports: ["generatePatientInsights"]
    - path: "src/lib/ai/patient-insights/index.ts"
      provides: "Module exports"
      exports: ["generatePatientInsights", "aggregatePatientSessions"]
  key_links:
    - from: "src/lib/ai/patient-insights/generator.ts"
      to: "src/lib/ai/summary-generator.ts"
      via: "generateAISummary function"
      pattern: "generateAISummary"
    - from: "src/lib/ai/patient-insights/generator.ts"
      to: "src/lib/ai/patient-insights/aggregator.ts"
      via: "aggregatePatientSessions and formatSessionsForInsights"
      pattern: "aggregatePatientSessions"
---

<objective>
Create AI-powered patient insight generator with prompts for 4 categories

Purpose: Build the core insight generation engine that analyzes all sessions for a patient and extracts patterns, progress trends, risk indicators, and treatment gaps using AI. This is the intelligence layer that transforms raw session data into actionable clinical insights.

Output: Prompt templates for insight extraction, generator function that produces PatientInsights
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-patient-insight-engine/04-01-SUMMARY.md
@src/types/index.ts
@src/lib/ai/index.ts
@src/lib/ai/summary-generator.ts
@src/lib/ai/mock-ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient insight prompts</name>
  <files>src/lib/ai/patient-insights/prompts.ts</files>
  <action>
Create a new file `src/lib/ai/patient-insights/prompts.ts` with the system prompt and user prompt builder for patient insight generation.

System prompt should:
- Establish the AI as a clinical analyst reviewing a patient's therapy history
- Instruct it to identify 4 categories of insights:
  1. **Patterns**: Recurring themes, behaviors, emotional patterns, coping mechanisms
  2. **Progress Trends**: Improvement or decline in symptoms, functioning, goal achievement
  3. **Risk Indicators**: Safety concerns, suicidal ideation, self-harm, substance use trends
  4. **Treatment Gaps**: Concerns mentioned but not addressed, recommended interventions not tried

- Require structured JSON output with arrays for each category
- Include confidence scores (0-1) for each insight
- Request session date references where applicable
- Support bilingual output (match input language - Hebrew or English)

Example system prompt structure:
```typescript
export const PATIENT_INSIGHT_SYSTEM_PROMPT = `You are a clinical analyst reviewing a mental health patient's complete therapy history.

Analyze the provided session notes and identify insights in four categories:

1. PATTERNS: Recurring themes, behaviors, emotional patterns, relationship dynamics, or coping mechanisms that appear across sessions.

2. PROGRESS_TRENDS: Evidence of improvement or decline over time in symptoms, daily functioning, goal achievement, or treatment engagement.

3. RISK_INDICATORS: Any safety concerns, suicidal/homicidal ideation, self-harm behaviors, or substance use patterns noted across sessions.

4. TREATMENT_GAPS: Concerns or issues mentioned by the patient that haven't been adequately addressed, or recommended interventions that haven't been implemented.

Output your analysis as JSON in this exact format:
{
  "patterns": [{ "content": "...", "confidence": 0.X, "sessionRefs": ["date1", "date2"] }],
  "progressTrends": [{ "content": "...", "confidence": 0.X, "firstSeen": "date", "lastSeen": "date" }],
  "riskIndicators": [{ "content": "...", "confidence": 0.X, "sessionRefs": ["date"] }],
  "treatmentGaps": [{ "content": "...", "confidence": 0.X }]
}

Guidelines:
- Provide 2-5 insights per category (fewer if data doesn't support more)
- Confidence scores: 0.9+ for clear evidence, 0.7-0.9 for moderate evidence, below 0.7 for tentative patterns
- Be clinically precise but accessible
- Match the language of the input (Hebrew or English)
- If insufficient data for a category, return an empty array`;
```

User prompt builder:
```typescript
export function buildInsightUserPrompt(formattedSessions: string, sessionCount: number): string {
  return `Patient Session History (${sessionCount} sessions):

${formattedSessions}

Please analyze these sessions and provide insights in the four categories.`;
}
```
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>PATIENT_INSIGHT_SYSTEM_PROMPT and buildInsightUserPrompt exported from prompts.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create insight generator with mock/real modes</name>
  <files>src/lib/ai/patient-insights/generator.ts</files>
  <action>
Create `src/lib/ai/patient-insights/generator.ts` with the main insight generation function.

Key function: `generatePatientInsights(patientId: string): Promise<PatientInsights>`

Implementation steps:
1. Call aggregatePatientSessions(patientId) to get all completed sessions
2. If no sessions, return empty PatientInsights with empty arrays
3. Call formatSessionsForInsights(sessions) to prepare AI input
4. Build prompts using PATIENT_INSIGHT_SYSTEM_PROMPT and buildInsightUserPrompt
5. Call generateAISummary(systemPrompt, userPrompt) from @/lib/ai
6. Parse the JSON response and map to PatientInsights structure
7. Handle parse errors gracefully (return error in result or use fallback)

For mock mode detection and fallback:
```typescript
import { getAIConfig } from '@/lib/ai';

// In generator:
const config = getAIConfig();
if (config.mode === 'mock') {
  return generateMockInsights(patientId, aggregated);
}
```

Mock insight generator (for development/testing):
- Create `generateMockInsights(patientId, aggregated)` that returns realistic sample insights
- Base mock content on actual session count and date range
- Include Hebrew mock content to match existing mock pattern

JSON parsing helper:
```typescript
function parseInsightResponse(responseText: string): ParsedInsights | null {
  try {
    // Handle potential markdown code fences
    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
    if (!jsonMatch) return null;
    return JSON.parse(jsonMatch[0]);
  } catch {
    return null;
  }
}
```

Error handling:
- If AI returns error, include it in result
- If JSON parse fails, log and return empty insights with error
- Never throw - always return a PatientInsights object
  </action>
  <verify>
Run `npx tsc --noEmit` to verify types compile.
Quick test: Import generatePatientInsights in a test file and call with 'patient-1', verify it returns a PatientInsights object with mode: 'mock'.
  </verify>
  <done>
generatePatientInsights function exists and:
- Returns PatientInsights for patient-1 with populated arrays in mock mode
- Handles the full pipeline: aggregate -> format -> prompt -> AI -> parse
- Never throws, always returns valid PatientInsights structure
  </done>
</task>

<task type="auto">
  <name>Task 3: Create module index with exports</name>
  <files>src/lib/ai/patient-insights/index.ts</files>
  <action>
Create `src/lib/ai/patient-insights/index.ts` as the module entry point.

Export all public functions:
```typescript
// Patient insight generation
export { generatePatientInsights } from './generator';

// Session aggregation utilities
export { aggregatePatientSessions, formatSessionsForInsights } from './aggregator';
export type { AggregatedSessions } from './aggregator';

// Re-export types for convenience
export type { PatientInsights, InsightItem } from '@/types';
```

This creates a clean API: `import { generatePatientInsights } from '@/lib/ai/patient-insights'`
  </action>
  <verify>
Run `npx tsc --noEmit` - compiles without errors.
Verify import works: `import { generatePatientInsights, aggregatePatientSessions } from '@/lib/ai/patient-insights'`
  </verify>
  <done>Module index exports all public functions and types</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `import { generatePatientInsights } from '@/lib/ai/patient-insights'` works
- Calling `generatePatientInsights('patient-1')` returns PatientInsights with non-empty arrays (in mock mode)
- Mock mode returns Hebrew content when sessions are in Hebrew
</verification>

<success_criteria>
- Patient insight system prompt covers all 4 categories (patterns, progress, risks, gaps)
- Generator integrates with existing AI module (generateAISummary)
- Mock mode provides realistic development insights without API calls
- Real mode sends prompts and parses structured JSON response
- All error cases handled gracefully (no throws, always return valid structure)
</success_criteria>

<output>
After completion, create `.planning/phases/04-patient-insight-engine/04-02-SUMMARY.md`
</output>
