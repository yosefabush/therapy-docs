---
phase: 04-patient-insight-engine
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/app/api/patients/[id]/insights/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/patients/[id]/insights generates patient insights"
    - "API returns PatientInsights JSON with 4 categories"
    - "API handles patient not found with 404"
    - "API handles no sessions gracefully"
  artifacts:
    - path: "src/app/api/patients/[id]/insights/route.ts"
      provides: "Patient insight generation endpoint"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/patients/[id]/insights/route.ts"
      to: "src/lib/ai/patient-insights"
      via: "generatePatientInsights function"
      pattern: "generatePatientInsights"
    - from: "src/app/api/patients/[id]/insights/route.ts"
      to: "patientRepository"
      via: "findById for validation"
      pattern: "findById"
---

<objective>
Create API route for patient insight generation

Purpose: Expose the patient insight engine via REST API so the UI (Phase 5) can trigger insight generation. This follows the same pattern as the session summary API route.

Output: POST /api/patients/[id]/insights endpoint that generates and returns PatientInsights
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-patient-insight-engine/04-02-SUMMARY.md
@src/app/api/sessions/[id]/summary/route.ts
@src/app/api/patients/[id]/route.ts
@src/lib/data/repositories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient insights API route</name>
  <files>src/app/api/patients/[id]/insights/route.ts</files>
  <action>
Create `src/app/api/patients/[id]/insights/route.ts` with POST handler for insight generation.

Follow the same pattern as the session summary route (`src/app/api/sessions/[id]/summary/route.ts`).

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { patientRepository } from '@/lib/data/repositories';
import { generatePatientInsights } from '@/lib/ai/patient-insights';

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const { id } = await params;

    // Validate patient exists
    const patient = await patientRepository.findById(id);
    if (!patient) {
      return NextResponse.json(
        { error: 'Patient not found' },
        { status: 404 }
      );
    }

    // Generate insights
    const insights = await generatePatientInsights(id);

    // Return insights
    return NextResponse.json({ data: insights });

  } catch (error) {
    console.error('Error generating patient insights:', error);
    return NextResponse.json(
      { error: 'Failed to generate insights' },
      { status: 500 }
    );
  }
}
```

Response format:
```json
{
  "data": {
    "id": "insight-...",
    "patientId": "patient-1",
    "patterns": [...],
    "progressTrends": [...],
    "riskIndicators": [...],
    "treatmentGaps": [...],
    "generatedAt": "2026-01-22T...",
    "mode": "mock"
  }
}
```

Error responses:
- 404: `{ "error": "Patient not found" }`
- 500: `{ "error": "Failed to generate insights" }`

Note: No GET endpoint yet - insights are generated on-demand. Persistence (GET existing insights) will be added in Phase 5.
  </action>
  <verify>
Start dev server: `npm run dev`
Test with curl:
```bash
# Should return 200 with PatientInsights data
curl -X POST http://localhost:3000/api/patients/patient-1/insights

# Should return 404
curl -X POST http://localhost:3000/api/patients/nonexistent/insights
```
  </verify>
  <done>
POST /api/patients/[id]/insights returns PatientInsights JSON.
Response includes all 4 insight categories.
Invalid patient ID returns 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify end-to-end insight generation</name>
  <files>N/A (verification only)</files>
  <action>
Perform end-to-end verification of the complete Phase 4 pipeline:

1. Start dev server if not running: `npm run dev`

2. Test insight generation for patient-1 (has 3 completed sessions):
```bash
curl -X POST http://localhost:3000/api/patients/patient-1/insights | jq .
```

Expected: Response with populated arrays for patterns, progressTrends, riskIndicators, treatmentGaps.

3. Test insight generation for patient-4 (has completed sessions with different therapists):
```bash
curl -X POST http://localhost:3000/api/patients/patient-4/insights | jq .
```

Expected: Response reflecting that patient's session history.

4. Test edge case - patient with no completed sessions (patient-3 has one scheduled, no completed):
Actually, check mock data - patient-3 has sessions. Find or note the edge case behavior.

5. Verify mode is 'mock' (no API key configured):
Check that response includes `"mode": "mock"`

6. Verify TypeScript types:
```bash
npx tsc --noEmit
```

Document any issues found for the summary.
  </action>
  <verify>
All curl commands return expected JSON structure.
`npm run build` passes.
`npx tsc --noEmit` passes.
  </verify>
  <done>
End-to-end pipeline works: API route -> generator -> aggregator -> mock AI -> parsed response.
All 4 insight categories populated for patients with session history.
Build passes with no TypeScript errors.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes
- `npx tsc --noEmit` passes
- POST /api/patients/patient-1/insights returns 200 with PatientInsights
- POST /api/patients/nonexistent/insights returns 404
- Response JSON has all required fields: id, patientId, patterns, progressTrends, riskIndicators, treatmentGaps, generatedAt, mode
</verification>

<success_criteria>
- API route exists at /api/patients/[id]/insights
- POST generates and returns PatientInsights
- Patient validation returns 404 for unknown patients
- Response follows established API pattern ({ data: ... } or { error: ... })
- End-to-end pipeline verified working
</success_criteria>

<output>
After completion, create `.planning/phases/04-patient-insight-engine/04-03-SUMMARY.md`
</output>
