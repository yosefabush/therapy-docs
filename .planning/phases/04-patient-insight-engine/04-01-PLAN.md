---
phase: 04-patient-insight-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/lib/ai/patient-insights/aggregator.ts
autonomous: true

must_haves:
  truths:
    - "PatientInsights type exists with 4 category arrays"
    - "Aggregator can load all completed sessions for a patient"
    - "Aggregator formats sessions into AI-consumable text"
  artifacts:
    - path: "src/types/index.ts"
      provides: "PatientInsights interface"
      contains: "interface PatientInsights"
    - path: "src/lib/ai/patient-insights/aggregator.ts"
      provides: "Session aggregation utilities"
      exports: ["aggregatePatientSessions", "formatSessionsForInsights"]
  key_links:
    - from: "src/lib/ai/patient-insights/aggregator.ts"
      to: "sessionRepository.findByPatient"
      via: "import and call"
      pattern: "findByPatient"
---

<objective>
Create PatientInsights type and session aggregation utilities

Purpose: Define the data structures for cross-session patient insights and build utilities to fetch and format all sessions for AI analysis. This is the foundation layer that the insight generator will use.

Output: PatientInsights interface in types, aggregator module that loads and formats session history
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/index.ts
@src/lib/ai/index.ts
@src/lib/ai-features.ts
@src/lib/data/repositories.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PatientInsights type to types/index.ts</name>
  <files>src/types/index.ts</files>
  <action>
Add PatientInsights interface after the existing AIInsight interface. The PatientInsights type represents a complete insight analysis for a patient with 4 categories as specified in requirements:

```typescript
export interface PatientInsights {
  id: string;
  patientId: string;

  // Four insight categories (INSI-03 through INSI-06)
  patterns: InsightItem[];        // Recurring themes, behaviors
  progressTrends: InsightItem[];  // Improvement/decline over time
  riskIndicators: InsightItem[];  // Risk factors across sessions
  treatmentGaps: InsightItem[];   // Mentioned but unaddressed concerns

  // Generation metadata
  generatedAt: Date;
  mode: 'mock' | 'real';
  model?: string;
  tokensUsed?: number;

  // Persistence metadata (for Phase 5)
  savedAt?: Date;
  savedBy?: string;
}

export interface InsightItem {
  content: string;           // The insight text
  confidence: number;        // 0-1 confidence score
  sessionRefs?: string[];    // Session IDs that support this insight
  firstSeen?: Date;          // When this pattern first appeared
  lastSeen?: Date;           // Most recent occurrence
}
```

This follows the same pattern as AISummary (generation + persistence metadata).
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors</verify>
  <done>PatientInsights and InsightItem interfaces exist in src/types/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create session aggregator module</name>
  <files>src/lib/ai/patient-insights/aggregator.ts</files>
  <action>
Create a new file `src/lib/ai/patient-insights/aggregator.ts` that provides utilities for fetching and formatting patient session data for AI insight generation.

Key functions to implement:

1. `aggregatePatientSessions(patientId: string): Promise<AggregatedSessions>` - Fetches all completed sessions for a patient, sorted chronologically. Uses sessionRepository.findByPatient() and filters for status === 'completed'.

2. `formatSessionsForInsights(sessions: Session[]): string` - Formats an array of sessions into a single text block for AI consumption. Include:
   - Session date and therapist role
   - Full SOAP notes content
   - Risk assessment if present
   - Medications if present
   - Progress toward goals if present
   - Use chronological order (oldest first)
   - Add clear section separators between sessions

Types to define:
```typescript
export interface AggregatedSessions {
  patientId: string;
  sessionCount: number;
  dateRange: { earliest: Date; latest: Date } | null;
  sessions: Session[];
}
```

Implementation notes:
- Import sessionRepository from '@/lib/data/repositories'
- Import Session, SessionNotes types from '@/types'
- Handle edge case of patient with zero completed sessions
- Format dates in ISO format for AI clarity
- Use similar SOAP formatting approach as ai-features.ts formatSOAPNotes() but include ALL fields
  </action>
  <verify>
Run `npx tsc --noEmit` to verify types compile.
Create a quick test by adding temporary console.log in any API route that calls aggregatePatientSessions('patient-1') and verify it returns 3+ sessions.
  </verify>
  <done>
aggregator.ts exports aggregatePatientSessions and formatSessionsForInsights functions.
Calling aggregatePatientSessions('patient-1') returns the 3 completed sessions for Avigail Berkowitz.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- PatientInsights interface is exported from @/types
- aggregator module is importable: `import { aggregatePatientSessions } from '@/lib/ai/patient-insights/aggregator'`
</verification>

<success_criteria>
- PatientInsights type defines the 4-category structure for patient insights
- InsightItem type captures individual insights with confidence and session references
- aggregatePatientSessions() fetches completed sessions for a patient from repository
- formatSessionsForInsights() produces AI-consumable text from session array
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-patient-insight-engine/04-01-SUMMARY.md`
</output>
