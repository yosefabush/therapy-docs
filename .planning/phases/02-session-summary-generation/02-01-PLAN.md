---
phase: 02-session-summary-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/index.ts
  - src/lib/ai/summary-generator.ts
  - src/lib/ai/mock-ai.ts
autonomous: true

must_haves:
  truths:
    - "generateAISummary() accepts prompts and returns AI-generated text"
    - "Mock mode returns realistic summaries without API calls"
    - "Real mode calls OpenAI-compatible API when configured"
    - "Summary output reflects role-specific prompt content"
  artifacts:
    - path: "src/lib/ai/index.ts"
      provides: "AI module exports and configuration"
      exports: ["generateAISummary", "AIConfig"]
    - path: "src/lib/ai/summary-generator.ts"
      provides: "Core AI generation logic with provider abstraction"
      exports: ["generateAISummary"]
    - path: "src/lib/ai/mock-ai.ts"
      provides: "Mock AI responses for development/testing"
      exports: ["generateMockSummary"]
  key_links:
    - from: "src/lib/ai/summary-generator.ts"
      to: "src/lib/ai/mock-ai.ts"
      via: "import and conditional call"
      pattern: "import.*generateMockSummary"
    - from: "src/lib/ai/summary-generator.ts"
      to: "OpenAI API"
      via: "fetch to configurable endpoint"
      pattern: "fetch.*OPENAI_API"
---

<objective>
Create the AI summary generation engine that can call either mock or real AI to generate session summaries.

Purpose: This is the core engine that transforms prompts (built by buildPromptFromSession from Phase 1) into actual AI-generated summaries. It supports both mock mode (for development/testing without API costs) and real mode (calling OpenAI-compatible APIs).

Output: A `src/lib/ai/` directory with summary generation logic that can be called by the API route (Plan 02).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-role-specific-prompts/01-02-SUMMARY.md

# Code files
@src/lib/ai-features.ts - buildPromptFromSession() to integrate with
@src/lib/prompts/index.ts - SessionSummaryPrompt type
@src/types/index.ts - Session, TherapistRole types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI module structure and configuration</name>
  <files>src/lib/ai/index.ts</files>
  <action>
Create `src/lib/ai/` directory and `index.ts` with:

1. `AIConfig` interface for configuration:
```typescript
export interface AIConfig {
  mode: 'mock' | 'real';
  apiKey?: string;
  apiEndpoint?: string;  // Defaults to OpenAI, but configurable
  model?: string;        // Defaults to gpt-4o-mini
  maxTokens?: number;    // Defaults to 1000
}
```

2. `getAIConfig()` function that reads from environment:
```typescript
export function getAIConfig(): AIConfig {
  const apiKey = process.env.OPENAI_API_KEY;
  const mode = apiKey ? 'real' : 'mock';

  return {
    mode,
    apiKey,
    apiEndpoint: process.env.OPENAI_API_ENDPOINT || 'https://api.openai.com/v1/chat/completions',
    model: process.env.OPENAI_MODEL || 'gpt-4o-mini',
    maxTokens: parseInt(process.env.OPENAI_MAX_TOKENS || '1000', 10),
  };
}
```

3. Re-export from summary-generator.ts (created in Task 2):
```typescript
export { generateAISummary } from './summary-generator';
export type { SummaryResult } from './summary-generator';
```

Environment variable pattern:
- No OPENAI_API_KEY = mock mode (safe for dev)
- OPENAI_API_KEY present = real mode
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/ai/index.ts`
  </verify>
  <done>
AIConfig interface exists; getAIConfig() reads environment; exports from module
  </done>
</task>

<task type="auto">
  <name>Task 2: Create summary generator with mock/real modes</name>
  <files>
src/lib/ai/summary-generator.ts
src/lib/ai/mock-ai.ts
  </files>
  <action>
Create `summary-generator.ts` with the core generation logic:

1. `SummaryResult` interface:
```typescript
export interface SummaryResult {
  summary: string;
  mode: 'mock' | 'real';
  model?: string;
  tokensUsed?: number;
  error?: string;
}
```

2. `generateAISummary()` function:
```typescript
export async function generateAISummary(
  systemPrompt: string,
  userPrompt: string
): Promise<SummaryResult> {
  const config = getAIConfig();

  if (config.mode === 'mock') {
    return generateMockSummary(systemPrompt, userPrompt);
  }

  return generateRealSummary(systemPrompt, userPrompt, config);
}
```

3. `generateRealSummary()` internal function that calls OpenAI API:
```typescript
async function generateRealSummary(
  systemPrompt: string,
  userPrompt: string,
  config: AIConfig
): Promise<SummaryResult> {
  try {
    const response = await fetch(config.apiEndpoint!, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${config.apiKey}`,
      },
      body: JSON.stringify({
        model: config.model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        max_tokens: config.maxTokens,
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      return {
        summary: '',
        mode: 'real',
        model: config.model,
        error: `API error ${response.status}: ${errorText}`,
      };
    }

    const data = await response.json();
    return {
      summary: data.choices[0]?.message?.content || '',
      mode: 'real',
      model: config.model,
      tokensUsed: data.usage?.total_tokens,
    };
  } catch (error) {
    return {
      summary: '',
      mode: 'real',
      model: config.model,
      error: `Request failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
    };
  }
}
```

Create `mock-ai.ts` with mock generation:

```typescript
export function generateMockSummary(
  systemPrompt: string,
  userPrompt: string
): SummaryResult {
  // Extract role from system prompt for role-appropriate mock
  const role = extractRoleFromPrompt(systemPrompt);

  // Generate a realistic mock summary based on role
  const summary = generateRoleSpecificMock(role, userPrompt);

  return {
    summary,
    mode: 'mock',
    model: 'mock-v1',
  };
}

function extractRoleFromPrompt(systemPrompt: string): string {
  // Extract role indicator from prompt content
  const rolePatterns = [
    { pattern: /psychologist|psychological/i, role: 'psychologist' },
    { pattern: /psychiatrist|psychiatric/i, role: 'psychiatrist' },
    { pattern: /social worker/i, role: 'social_worker' },
    { pattern: /occupational therapist|OT /i, role: 'occupational_therapist' },
    { pattern: /speech therapist|speech-language/i, role: 'speech_therapist' },
    { pattern: /physical therapist|PT |physiotherapist/i, role: 'physical_therapist' },
    { pattern: /counselor/i, role: 'counselor' },
    { pattern: /art therapist/i, role: 'art_therapist' },
    { pattern: /music therapist/i, role: 'music_therapist' },
    { pattern: /family therapist/i, role: 'family_therapist' },
  ];

  for (const { pattern, role } of rolePatterns) {
    if (pattern.test(systemPrompt)) {
      return role;
    }
  }
  return 'generic';
}

function generateRoleSpecificMock(role: string, userPrompt: string): string {
  // Check if Hebrew content (for bilingual support)
  const isHebrew = /[\u0590-\u05FF]/.test(userPrompt);

  const mockTemplates: Record<string, { en: string; he: string }> = {
    psychologist: {
      en: `**Clinical Session Summary**

The patient presented with moderate anxiety symptoms during today's session. Cognitive patterns observed include negative self-talk and catastrophic thinking, particularly around work-related stressors.

**Key Observations:**
- Patient demonstrated insight into anxiety triggers
- Successfully practiced grounding techniques during session
- Homework from previous session was partially completed

**Clinical Impression:**
The patient is showing gradual progress in identifying and challenging automatic negative thoughts. CBT interventions continue to be appropriate for the presenting concerns.

**Next Steps:**
Continue cognitive restructuring work; assign thought record for tracking anxiety episodes.`,
      he: `**סיכום מפגש קליני**

המטופל/ת הציג/ה סימפטומים של חרדה ברמה בינונית במהלך המפגש. דפוסי חשיבה שנצפו כוללים שיח עצמי שלילי וחשיבה קטסטרופלית, במיוחד סביב מתחים הקשורים לעבודה.

**תצפיות עיקריות:**
- המטופל/ת הפגין/ה תובנה לגבי טריגרים לחרדה
- תרגול מוצלח של טכניקות הארקה במהלך המפגש
- שיעורי בית מהמפגש הקודם הושלמו חלקית

**התרשמות קלינית:**
המטופל/ת מראה התקדמות הדרגתית בזיהוי ואתגור מחשבות אוטומטיות שליליות. התערבויות CBT ממשיכות להיות מתאימות לבעיות המוצגות.

**צעדים הבאים:**
המשך עבודה על ארגון מחדש קוגניטיבי; מתן יומן מחשבות למעקב אחר אירועי חרדה.`
    },
    psychiatrist: {
      en: `**Psychiatric Consultation Summary**

Current medication regimen reviewed and patient reports adherence. Mood has shown improvement since last adjustment.

**Mental Status Examination:**
- Appearance: Appropriately dressed, good hygiene
- Mood/Affect: Euthymic with reactive affect
- Thought Process: Linear and goal-directed
- No current suicidal or homicidal ideation

**Medication Notes:**
Current medications well-tolerated. No significant side effects reported. Sleep quality has improved.

**Plan:**
Continue current regimen. Follow-up in 4 weeks. Labs ordered for routine monitoring.`,
      he: `**סיכום התייעצות פסיכיאטרית**

נסקר משטר התרופות הנוכחי והמטופל/ת מדווח/ת על היענות. מצב הרוח הראה שיפור מאז ההתאמה האחרונה.

**בחינת מצב נפשי:**
- מראה: לבוש/ה בהתאם, היגיינה תקינה
- מצב רוח/אפקט: אאוטימי עם אפקט תגובתי
- תהליך חשיבה: ליניארי ומכוון מטרה
- אין אידאציה אובדנית או רצחנית נוכחית

**הערות תרופות:**
התרופות הנוכחיות נסבלות היטב. לא דווחו תופעות לוואי משמעותיות. איכות השינה השתפרה.

**תוכנית:**
המשך משטר נוכחי. מעקב בעוד 4 שבועות. בדיקות מעבדה הוזמנו לניטור שגרתי.`
    },
    // Add more role templates as needed - keep concise for mock
    generic: {
      en: `**Session Summary**

Session completed successfully. Patient engaged appropriately throughout the session.

**Key Points:**
- Patient presented with ongoing concerns
- Therapeutic interventions were applied
- Progress noted toward treatment goals

**Plan:**
Continue current treatment approach. Schedule follow-up session.`,
      he: `**סיכום מפגש**

המפגש הושלם בהצלחה. המטופל/ת היה/תה מעורב/ת לאורך כל המפגש.

**נקודות מפתח:**
- המטופל/ת הציג/ה דאגות מתמשכות
- הופעלו התערבויות טיפוליות
- צוינה התקדמות לקראת יעדי הטיפול

**תוכנית:**
המשך גישת הטיפול הנוכחית. לקבוע מפגש מעקב.`
    }
  };

  const template = mockTemplates[role] || mockTemplates.generic;
  return isHebrew ? template.he : template.en;
}
```

Add mock templates for all 10 roles with Hebrew/English variants. Keep mocks realistic but recognizably mock (for testing).
  </action>
  <verify>
`npm run lint` passes
`npx tsc --noEmit src/lib/ai/*.ts` passes
Both mock and real code paths are type-safe
  </verify>
  <done>
generateAISummary() exists with mock/real mode switching; mock returns role-appropriate summaries; real calls OpenAI API with proper error handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Create high-level session summary function</name>
  <files>src/lib/ai/index.ts</files>
  <action>
Add a convenience function that combines buildPromptFromSession with generateAISummary:

```typescript
import { Session, TherapistRole } from '@/types';
import { buildPromptFromSession } from '../ai-features';
import { generateAISummary, SummaryResult } from './summary-generator';

/**
 * Generate an AI summary for a session using role-specific prompts
 *
 * @param session - The session to summarize
 * @param therapistRole - Role for prompt selection
 * @param transcript - Optional session transcript
 * @returns Promise with generated summary and metadata
 *
 * @example
 * const result = await generateSessionSummaryAI(session, 'psychiatrist', transcript);
 * if (result.error) {
 *   console.error('Generation failed:', result.error);
 * } else {
 *   console.log('Summary:', result.summary);
 * }
 */
export async function generateSessionSummaryAI(
  session: Session,
  therapistRole: TherapistRole,
  transcript?: string
): Promise<SummaryResult> {
  const { systemPrompt, userPrompt } = buildPromptFromSession(
    session,
    therapistRole,
    transcript
  );

  return generateAISummary(systemPrompt, userPrompt);
}
```

Update exports in index.ts:
```typescript
export { generateSessionSummaryAI } from './index';
export { generateAISummary } from './summary-generator';
export type { SummaryResult } from './summary-generator';
export { getAIConfig } from './index';
export type { AIConfig } from './index';
```
  </action>
  <verify>
`npm run build` passes
Import from '@/lib/ai' works: `import { generateSessionSummaryAI } from '@/lib/ai'`
  </verify>
  <done>
generateSessionSummaryAI() combines prompt building with AI generation; clean API for Plan 02 to use
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` passes
3. src/lib/ai/ directory contains index.ts, summary-generator.ts, mock-ai.ts
4. Mock mode generates role-appropriate summaries without API calls
5. Real mode constructs valid OpenAI API requests
6. Error handling covers API failures gracefully
7. Bilingual support (Hebrew/English) works in mock mode
</verification>

<success_criteria>
- AI module exists at src/lib/ai/
- generateAISummary() works in mock mode without API key
- generateAISummary() calls OpenAI when API key configured
- generateSessionSummaryAI() combines prompt building + generation
- Error responses include meaningful error messages
- TypeScript compilation passes
- Ready for API route integration (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-summary-generation/02-01-SUMMARY.md`
</output>
