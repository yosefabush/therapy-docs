---
phase: 02-session-summary-generation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/sessions/[id]/summary/route.ts
  - src/lib/ai-features.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/sessions/[id]/summary returns AI-generated summary"
    - "API accepts optional transcript in request body"
    - "API returns generated summary with metadata (mode, model)"
    - "API handles errors gracefully with appropriate status codes"
    - "generateSessionSummary() can optionally use AI generation"
  artifacts:
    - path: "src/app/api/sessions/[id]/summary/route.ts"
      provides: "POST endpoint for summary generation"
      exports: ["POST"]
    - path: "src/lib/ai-features.ts"
      provides: "Updated generateSessionSummary with AI option"
      exports: ["generateSessionSummary"]
      contains: "generateSessionSummaryAI"
  key_links:
    - from: "src/app/api/sessions/[id]/summary/route.ts"
      to: "src/lib/ai/index.ts"
      via: "import generateSessionSummaryAI"
      pattern: "import.*generateSessionSummaryAI.*from.*ai"
    - from: "src/app/api/sessions/[id]/summary/route.ts"
      to: "sessionRepository"
      via: "session lookup before generation"
      pattern: "sessionRepository\\.findById"
---

<objective>
Create the API route that frontend can call to generate AI summaries for sessions.

Purpose: This API route is the interface between the frontend UI (Phase 3) and the AI generation engine (Plan 01). It fetches the session, validates access, generates the summary using the AI engine, and returns the result.

Output: A Next.js API route at `/api/sessions/[id]/summary` that accepts POST requests to generate summaries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-session-summary-generation/02-01-SUMMARY.md

# Code files
@src/app/api/sessions/[id]/route.ts - Existing session API pattern to follow
@src/lib/ai/index.ts - AI generation module from Plan 01
@src/lib/data/repositories.ts - sessionRepository for data access
@src/types/index.ts - Session, TherapistRole types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create summary generation API route</name>
  <files>src/app/api/sessions/[id]/summary/route.ts</files>
  <action>
Create the API route following existing patterns in the codebase:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { sessionRepository } from '@/lib/data/repositories';
import { generateSessionSummaryAI, getAIConfig } from '@/lib/ai';

interface SummaryRequest {
  transcript?: string;
  regenerate?: boolean;  // Force regeneration even if summary exists
}

interface SummaryResponse {
  data?: {
    summary: string;
    mode: 'mock' | 'real';
    model?: string;
    tokensUsed?: number;
    generatedAt: string;
  };
  error?: string;
}

/**
 * POST /api/sessions/[id]/summary
 *
 * Generates an AI summary for the specified session.
 *
 * Request body:
 * - transcript (optional): Session transcript for richer summary
 * - regenerate (optional): Force regeneration if summary exists
 *
 * Response:
 * - 200: Summary generated successfully
 * - 400: Invalid request (missing session data)
 * - 404: Session not found
 * - 500: Generation failed
 */
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
): Promise<NextResponse<SummaryResponse>> {
  try {
    const { id } = await params;

    // 1. Fetch the session
    const session = await sessionRepository.findById(id);

    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      );
    }

    // 2. Validate session has notes to summarize
    if (!session.notes || !session.notes.subjective) {
      return NextResponse.json(
        { error: 'Session has no notes to summarize. Please add session notes first.' },
        { status: 400 }
      );
    }

    // 3. Parse request body
    let body: SummaryRequest = {};
    try {
      const text = await request.text();
      if (text) {
        body = JSON.parse(text);
      }
    } catch {
      // Empty body is fine - transcript is optional
    }

    // 4. Generate the summary
    const result = await generateSessionSummaryAI(
      session,
      session.therapistRole,
      body.transcript
    );

    // 5. Check for generation errors
    if (result.error) {
      console.error(`Summary generation failed for session ${id}:`, result.error);
      return NextResponse.json(
        { error: `Summary generation failed: ${result.error}` },
        { status: 500 }
      );
    }

    // 6. Return success response
    return NextResponse.json({
      data: {
        summary: result.summary,
        mode: result.mode,
        model: result.model,
        tokensUsed: result.tokensUsed,
        generatedAt: new Date().toISOString(),
      }
    });

  } catch (error) {
    console.error('Error in summary generation:', error);
    return NextResponse.json(
      { error: 'Failed to generate summary' },
      { status: 500 }
    );
  }
}

/**
 * GET /api/sessions/[id]/summary
 *
 * Returns the current AI configuration mode (for frontend to display).
 * Useful for showing "Mock Mode" badge in development.
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
): Promise<NextResponse> {
  try {
    const { id } = await params;

    // Verify session exists
    const session = await sessionRepository.findById(id);
    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      );
    }

    const config = getAIConfig();

    return NextResponse.json({
      data: {
        mode: config.mode,
        model: config.model,
        sessionId: id,
        hasNotes: Boolean(session.notes?.subjective),
      }
    });

  } catch (error) {
    console.error('Error fetching summary config:', error);
    return NextResponse.json(
      { error: 'Failed to fetch configuration' },
      { status: 500 }
    );
  }
}
```

Key implementation details:
- Follow existing API patterns (NextRequest, NextResponse, params Promise)
- Validate session exists before generation
- Handle missing notes gracefully (400 vs 500)
- Support optional transcript in request body
- Return metadata (mode, model, tokensUsed) for frontend display
- GET endpoint for checking configuration state
  </action>
  <verify>
`npm run lint` passes
`npx tsc --noEmit src/app/api/sessions/[id]/summary/route.ts` passes
API route file exists at correct path
  </verify>
  <done>
POST /api/sessions/[id]/summary generates AI summary; GET returns configuration; proper error handling for all cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Update generateSessionSummary to support AI mode</name>
  <files>src/lib/ai-features.ts</files>
  <action>
Update the existing generateSessionSummary() function to optionally use AI generation:

1. Add import for the new AI module:
```typescript
import { generateSessionSummaryAI, SummaryResult } from './ai';
```

2. Add an overloaded version that returns a Promise when AI is requested:
```typescript
/**
 * Generate a session summary - synchronous stub version
 * @deprecated Use generateSessionSummaryAI() for actual AI generation
 */
export function generateSessionSummary(session: Session, therapistRole: TherapistRole): string;

/**
 * Generate a session summary - async AI version
 */
export function generateSessionSummary(
  session: Session,
  therapistRole: TherapistRole,
  options: { useAI: true; transcript?: string }
): Promise<SummaryResult>;

export function generateSessionSummary(
  session: Session,
  therapistRole: TherapistRole,
  options?: { useAI?: boolean; transcript?: string }
): string | Promise<SummaryResult> {
  // If AI mode requested, use the new AI generation
  if (options?.useAI) {
    return generateSessionSummaryAI(session, therapistRole, options.transcript);
  }

  // Otherwise use existing stub implementation for backward compatibility
  const { notes, sessionType, duration } = session;

  const summaryStyles: Record<TherapistRole, (session: Session) => string> = {
    psychologist: (s) => generatePsychologySummary(s),
    psychiatrist: (s) => generatePsychiatrySummary(s),
    // ... rest of existing stub implementations
  };

  const generator = summaryStyles[therapistRole];
  return generator ? generator(session) : generateGenericSummary(session);
}
```

3. Add a comment documenting the migration path:
```typescript
/**
 * Session Summary Generation
 *
 * Two modes available:
 *
 * 1. Stub mode (default, synchronous):
 *    const summary = generateSessionSummary(session, role);
 *    - Uses hardcoded templates
 *    - No API calls
 *    - For backward compatibility
 *
 * 2. AI mode (async):
 *    const result = await generateSessionSummary(session, role, { useAI: true });
 *    - Uses role-specific prompts
 *    - Calls AI API (or mock)
 *    - Returns SummaryResult with metadata
 *
 * For new code, prefer using generateSessionSummaryAI() directly from '@/lib/ai'.
 */
```

This preserves backward compatibility while enabling AI mode through an options parameter.
  </action>
  <verify>
`npm run lint` passes
`npm run build` passes
Existing code using generateSessionSummary() still works (no breaking changes)
  </verify>
  <done>
generateSessionSummary() supports { useAI: true } option; existing synchronous usage unchanged; clear documentation for migration
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` passes
3. API route exists at src/app/api/sessions/[id]/summary/route.ts
4. POST request generates summary (test with curl or similar)
5. GET request returns configuration
6. Error cases return appropriate status codes
7. Existing generateSessionSummary() calls still work
8. New AI mode accessible via options parameter
</verification>

<success_criteria>
- POST /api/sessions/[id]/summary generates and returns AI summary
- API validates session exists and has notes
- API handles errors gracefully (404, 400, 500)
- Response includes metadata (mode, model, tokensUsed)
- GET endpoint provides configuration info
- generateSessionSummary() updated with backward-compatible AI option
- TypeScript compilation passes
- Ready for UI integration (Phase 3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-summary-generation/02-02-SUMMARY.md`
</output>
