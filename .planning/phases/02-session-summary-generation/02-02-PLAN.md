---
phase: 02-session-summary-generation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/app/api/sessions/[id]/summary/route.ts
  - src/lib/ai-features.ts
  - src/lib/ai/index.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/sessions/[id]/summary returns AI-generated summary"
    - "API accepts optional transcript in request body for richer summaries"
    - "API returns summary with metadata (mode, model, generatedAt)"
    - "API returns 404 for non-existent sessions, 400 for sessions without notes"
    - "Existing generateSessionSummary() callers continue to work without changes"
  artifacts:
    - path: "src/app/api/sessions/[id]/summary/route.ts"
      provides: "POST endpoint for summary generation"
      exports: ["POST", "GET"]
    - path: "src/lib/ai-features.ts"
      provides: "Updated generateSessionSummary with AI option"
      exports: ["generateSessionSummary"]
    - path: "src/lib/ai/index.ts"
      provides: "High-level session summary function"
      exports: ["generateSessionSummaryAI"]
  key_links:
    - from: "src/app/api/sessions/[id]/summary/route.ts"
      to: "src/lib/ai/index.ts"
      via: "import generateSessionSummaryAI"
      pattern: "import.*generateSessionSummaryAI.*from.*ai"
    - from: "src/app/api/sessions/[id]/summary/route.ts"
      to: "sessionRepository"
      via: "session lookup before generation"
      pattern: "sessionRepository\\.findById"
    - from: "src/lib/ai-features.ts"
      to: "src/lib/ai/index.ts"
      via: "import for AI mode"
      pattern: "import.*generateSessionSummaryAI.*from.*ai"
---

<objective>
Create the API route that frontend can call to generate AI summaries for sessions, and add the high-level generateSessionSummaryAI convenience function.

Purpose: This API route is the interface between the frontend UI (Phase 3) and the AI generation engine (Plan 01). It fetches the session, validates access, generates the summary using the AI engine, and returns the result. The generateSessionSummaryAI convenience function combines buildPromptFromSession with generateAISummary.

Output: A Next.js API route at `/api/sessions/[id]/summary` that accepts POST requests to generate summaries, plus updated ai-features.ts with backward-compatible AI mode option.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-session-summary-generation/02-01-SUMMARY.md

# Code files
@src/app/api/sessions/[id]/route.ts - Existing session API pattern to follow
@src/lib/ai/index.ts - AI generation module from Plan 01
@src/lib/data/repositories.ts - sessionRepository for data access
@src/types/index.ts - Session, TherapistRole types (note: Session.notes is required field)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create high-level generateSessionSummaryAI function</name>
  <files>src/lib/ai/index.ts</files>
  <action>
Add the convenience function that combines buildPromptFromSession with generateAISummary to the AI module (from Plan 01):

```typescript
import { Session, TherapistRole } from '@/types';
import { buildPromptFromSession } from '../ai-features';
import { generateAISummary, SummaryResult } from './summary-generator';

/**
 * Generate an AI summary for a session using role-specific prompts
 *
 * @param session - The session to summarize
 * @param therapistRole - Role for prompt selection
 * @param transcript - Optional session transcript
 * @returns Promise with generated summary and metadata
 *
 * @example
 * const result = await generateSessionSummaryAI(session, 'psychiatrist', transcript);
 * if (result.error) {
 *   console.error('Generation failed:', result.error);
 * } else {
 *   console.log('Summary:', result.summary);
 * }
 */
export async function generateSessionSummaryAI(
  session: Session,
  therapistRole: TherapistRole,
  transcript?: string
): Promise<SummaryResult> {
  const { systemPrompt, userPrompt } = buildPromptFromSession(
    session,
    therapistRole,
    transcript
  );

  return generateAISummary(systemPrompt, userPrompt);
}
```

Update exports in index.ts to include generateSessionSummaryAI:
```typescript
export { generateSessionSummaryAI } from './index';
export { generateAISummary } from './summary-generator';
export type { SummaryResult } from './summary-generator';
export { getAIConfig } from './index';
export type { AIConfig } from './index';
```

This function will be imported by both the API route and optionally by ai-features.ts for the updated generateSessionSummary.
  </action>
  <verify>
`npx tsc --noEmit src/lib/ai/index.ts` passes
Import from '@/lib/ai' works: `import { generateSessionSummaryAI } from '@/lib/ai'`
  </verify>
  <done>
generateSessionSummaryAI() combines prompt building with AI generation; exported from @/lib/ai module
  </done>
</task>

<task type="auto">
  <name>Task 2: Create summary generation API route</name>
  <files>src/app/api/sessions/[id]/summary/route.ts</files>
  <action>
Create the API route following existing patterns in the codebase:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { sessionRepository } from '@/lib/data/repositories';
import { generateSessionSummaryAI, getAIConfig } from '@/lib/ai';

interface SummaryRequest {
  transcript?: string;
  regenerate?: boolean;  // Force regeneration even if summary exists
}

interface SummaryResponse {
  data?: {
    summary: string;
    mode: 'mock' | 'real';
    model?: string;
    tokensUsed?: number;
    generatedAt: string;
  };
  error?: string;
}

/**
 * POST /api/sessions/[id]/summary
 *
 * Generates an AI summary for the specified session.
 *
 * Request body:
 * - transcript (optional): Session transcript for richer summary
 * - regenerate (optional): Force regeneration if summary exists
 *
 * Response:
 * - 200: Summary generated successfully
 * - 400: Invalid request (missing session data)
 * - 404: Session not found
 * - 500: Generation failed
 */
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
): Promise<NextResponse<SummaryResponse>> {
  try {
    const { id } = await params;

    // 1. Fetch the session
    const session = await sessionRepository.findById(id);

    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      );
    }

    // 2. Validate session has notes to summarize
    // Note: Session.notes is a required field per types/index.ts
    // but we check subjective specifically as it's needed for summary
    if (!session.notes.subjective) {
      return NextResponse.json(
        { error: 'Session has no subjective notes to summarize. Please add session notes first.' },
        { status: 400 }
      );
    }

    // 3. Parse request body
    let body: SummaryRequest = {};
    try {
      const text = await request.text();
      if (text) {
        body = JSON.parse(text);
      }
    } catch {
      // Empty body is fine - transcript is optional
    }

    // 4. Generate the summary
    const result = await generateSessionSummaryAI(
      session,
      session.therapistRole,
      body.transcript
    );

    // 5. Check for generation errors
    if (result.error) {
      console.error(`Summary generation failed for session ${id}:`, result.error);
      return NextResponse.json(
        { error: `Summary generation failed: ${result.error}` },
        { status: 500 }
      );
    }

    // 6. Return success response
    return NextResponse.json({
      data: {
        summary: result.summary,
        mode: result.mode,
        model: result.model,
        tokensUsed: result.tokensUsed,
        generatedAt: new Date().toISOString(),
      }
    });

  } catch (error) {
    console.error('Error in summary generation:', error);
    return NextResponse.json(
      { error: 'Failed to generate summary' },
      { status: 500 }
    );
  }
}

/**
 * GET /api/sessions/[id]/summary
 *
 * Returns the current AI configuration mode (for frontend to display).
 * Useful for showing "Mock Mode" badge in development.
 */
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
): Promise<NextResponse> {
  try {
    const { id } = await params;

    // Verify session exists
    const session = await sessionRepository.findById(id);
    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      );
    }

    const config = getAIConfig();

    return NextResponse.json({
      data: {
        mode: config.mode,
        model: config.model,
        sessionId: id,
        hasNotes: Boolean(session.notes.subjective),
      }
    });

  } catch (error) {
    console.error('Error fetching summary config:', error);
    return NextResponse.json(
      { error: 'Failed to fetch configuration' },
      { status: 500 }
    );
  }
}
```

Key implementation details:
- Follow existing API patterns (NextRequest, NextResponse, params Promise)
- Validate session exists before generation
- Session.notes is required per types, check session.notes.subjective (not session.notes?.subjective)
- Handle missing subjective notes gracefully (400 vs 500)
- Support optional transcript in request body
- Return metadata (mode, model, tokensUsed) for frontend display
- GET endpoint for checking configuration state
  </action>
  <verify>
`npm run lint` passes
`npx tsc --noEmit src/app/api/sessions/[id]/summary/route.ts` passes
API route file exists at correct path
  </verify>
  <done>
POST /api/sessions/[id]/summary generates AI summary; GET returns configuration; proper error handling for all cases
  </done>
</task>

<task type="auto">
  <name>Task 3: Update generateSessionSummary to support AI mode</name>
  <files>src/lib/ai-features.ts</files>
  <action>
IMPORTANT: First verify existing callers of generateSessionSummary() to ensure backward compatibility:
```bash
grep -r 'generateSessionSummary(' src/
```

Known callers (as of planning):
- src/lib/ai-features.ts:312 (internal usage)
- src/app/sessions/[id]/page.tsx:55 (UI usage - synchronous call)

Both existing callers use the 2-argument form: generateSessionSummary(session, role)
These MUST continue to work without modification.

Update the existing generateSessionSummary() function to optionally use AI generation:

1. Add import for the new AI module:
```typescript
import { generateSessionSummaryAI, SummaryResult } from './ai';
```

2. Add an overloaded version that returns a Promise when AI is requested:
```typescript
/**
 * Session Summary Generation
 *
 * Two modes available:
 *
 * 1. Stub mode (default, synchronous):
 *    const summary = generateSessionSummary(session, role);
 *    - Uses hardcoded templates
 *    - No API calls
 *    - For backward compatibility
 *
 * 2. AI mode (async):
 *    const result = await generateSessionSummary(session, role, { useAI: true });
 *    - Uses role-specific prompts
 *    - Calls AI API (or mock)
 *    - Returns SummaryResult with metadata
 *
 * For new code, prefer using generateSessionSummaryAI() directly from '@/lib/ai'.
 */

/**
 * Generate a session summary - synchronous stub version
 * @deprecated Use generateSessionSummaryAI() for actual AI generation
 */
export function generateSessionSummary(session: Session, therapistRole: TherapistRole): string;

/**
 * Generate a session summary - async AI version
 */
export function generateSessionSummary(
  session: Session,
  therapistRole: TherapistRole,
  options: { useAI: true; transcript?: string }
): Promise<SummaryResult>;

export function generateSessionSummary(
  session: Session,
  therapistRole: TherapistRole,
  options?: { useAI?: boolean; transcript?: string }
): string | Promise<SummaryResult> {
  // If AI mode requested, use the new AI generation
  if (options?.useAI) {
    return generateSessionSummaryAI(session, therapistRole, options.transcript);
  }

  // Otherwise use existing stub implementation for backward compatibility
  const { notes, sessionType, duration } = session;

  const summaryStyles: Record<TherapistRole, (session: Session) => string> = {
    psychologist: (s) => generatePsychologySummary(s),
    psychiatrist: (s) => generatePsychiatrySummary(s),
    // ... rest of existing stub implementations
  };

  const generator = summaryStyles[therapistRole];
  return generator ? generator(session) : generateGenericSummary(session);
}
```

This preserves backward compatibility while enabling AI mode through an options parameter.
  </action>
  <verify>
First run: `grep -r 'generateSessionSummary(' src/` to list all callers
Then verify:
- `npm run lint` passes
- `npm run build` passes
- Existing callers in src/app/sessions/[id]/page.tsx and src/lib/ai-features.ts still work (no TypeScript errors)
  </verify>
  <done>
generateSessionSummary() supports { useAI: true } option; existing 2-argument calls unchanged; all existing callers verified compatible
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` passes
3. API route exists at src/app/api/sessions/[id]/summary/route.ts
4. POST request generates summary (test with curl or similar)
5. GET request returns configuration
6. Error cases return appropriate status codes (404, 400, 500)
7. Existing generateSessionSummary() calls still work
8. New AI mode accessible via options parameter
9. generateSessionSummaryAI() exported from @/lib/ai
</verification>

<success_criteria>
- POST /api/sessions/[id]/summary generates and returns AI summary
- API validates session exists and has subjective notes
- API handles errors gracefully (404, 400, 500)
- Response includes metadata (mode, model, tokensUsed)
- GET endpoint provides configuration info
- generateSessionSummary() updated with backward-compatible AI option
- Existing callers verified and unaffected
- TypeScript compilation passes
- Ready for UI integration (Phase 3)
</success_criteria>

<output>
After completion, create `.planning/phases/02-session-summary-generation/02-02-SUMMARY.md`
</output>
