---
phase: 01-role-specific-prompts
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/ai-features.ts
autonomous: true

must_haves:
  truths:
    - "generateSessionSummary() uses role-specific prompts from prompts/ directory"
    - "Prompt selection is based on therapist role parameter"
    - "Both SOAP notes and transcript are passed to prompt template"
    - "Existing function signature remains compatible"
  artifacts:
    - path: "src/lib/ai-features.ts"
      provides: "Updated generateSessionSummary with prompt integration"
      exports: ["generateSessionSummary"]
      contains: "getPromptForRole"
  key_links:
    - from: "src/lib/ai-features.ts"
      to: "src/lib/prompts/index.ts"
      via: "import getPromptForRole"
      pattern: "import.*getPromptForRole.*from.*prompts"
    - from: "generateSessionSummary function"
      to: "prompt userPromptTemplate"
      via: "template variable substitution"
      pattern: "replace.*soapNotes|replace.*transcript"
---

<objective>
Integrate the role-specific prompts into the existing generateSessionSummary() function in ai-features.ts.

Purpose: Connect the prompt infrastructure to the existing role dispatch pattern. After this plan, calling generateSessionSummary() will select the correct role-specific prompt and prepare it with session data - ready for AI generation in Phase 2.

Output: Updated ai-features.ts that uses getPromptForRole() to select prompts and builds the final prompt string from SOAP notes and transcript.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-role-specific-prompts/01-01-SUMMARY.md

# Code files
@src/lib/ai-features.ts - Current implementation to update
@src/lib/prompts/index.ts - Prompt registry from Plan 01
@src/types/index.ts - Session, SessionNotes, TherapistRole types
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prompt integration to generateSessionSummary</name>
  <files>src/lib/ai-features.ts</files>
  <action>
Update generateSessionSummary() to use the new prompt system:

1. Add import at top of file:
```typescript
import { getPromptForRole, SessionSummaryPrompt } from './prompts';
```

2. Add a new helper function `buildPromptFromSession()`:
```typescript
export function buildPromptFromSession(
  session: Session,
  therapistRole: TherapistRole,
  transcript?: string
): { systemPrompt: string; userPrompt: string } {
  const promptConfig = getPromptForRole(therapistRole);

  // Format SOAP notes from session
  const soapNotes = formatSOAPNotes(session.notes);

  // Replace template variables
  const userPrompt = promptConfig.userPromptTemplate
    .replace('{{soapNotes}}', soapNotes)
    .replace('{{transcript}}', transcript || '(No transcript available)');

  return {
    systemPrompt: promptConfig.systemPrompt,
    userPrompt
  };
}
```

3. Add helper function `formatSOAPNotes()`:
```typescript
function formatSOAPNotes(notes: SessionNotes): string {
  const sections: string[] = [];

  if (notes.chiefComplaint) {
    sections.push(`Chief Complaint: ${notes.chiefComplaint}`);
  }
  sections.push(`Subjective: ${notes.subjective}`);
  sections.push(`Objective: ${notes.objective}`);
  sections.push(`Assessment: ${notes.assessment}`);
  sections.push(`Plan: ${notes.plan}`);

  if (notes.interventionsUsed?.length) {
    sections.push(`Interventions Used: ${notes.interventionsUsed.join(', ')}`);
  }
  if (notes.progressTowardGoals) {
    sections.push(`Progress Toward Goals: ${notes.progressTowardGoals}`);
  }
  if (notes.medications?.length) {
    const meds = notes.medications.map(m => `${m.name} ${m.dosage} ${m.frequency}`).join('; ');
    sections.push(`Medications: ${meds}`);
  }
  if (notes.riskAssessment) {
    sections.push(`Risk Assessment: SI=${notes.riskAssessment.suicidalIdeation}, HI=${notes.riskAssessment.homicidalIdeation}, SH=${notes.riskAssessment.selfHarm}`);
  }
  if (notes.homework) {
    sections.push(`Homework: ${notes.homework}`);
  }
  if (notes.nextSessionPlan) {
    sections.push(`Next Session Plan: ${notes.nextSessionPlan}`);
  }

  return sections.join('\n\n');
}
```

4. Keep the existing generateSessionSummary() function as-is for now (it uses the stub implementations). Add a comment noting it will be replaced by AI generation in Phase 2:
```typescript
// TODO (Phase 2): Replace stub generators with AI call using buildPromptFromSession()
```

5. Export the new function for use by Phase 2:
```typescript
export { buildPromptFromSession };
```

DO NOT remove the existing role-specific stub functions (generatePsychologySummary, etc.) - they serve as fallback until Phase 2 implements AI generation.
  </action>
  <verify>
`npm run lint` passes
`npx tsc --noEmit` passes
Import of getPromptForRole compiles without errors
  </verify>
  <done>
buildPromptFromSession() exists and can build a complete prompt from session data and role; formatSOAPNotes() formats all SessionNotes fields; existing generateSessionSummary() remains functional
  </done>
</task>

<task type="auto">
  <name>Task 2: Add type exports and verify integration</name>
  <files>src/lib/ai-features.ts</files>
  <action>
1. Ensure SessionSummaryPrompt type is re-exported for external use:
```typescript
export type { SessionSummaryPrompt } from './prompts';
```

2. Add a simple integration test comment/example showing usage:
```typescript
/**
 * Example usage (Phase 2 will implement this):
 *
 * const { systemPrompt, userPrompt } = buildPromptFromSession(session, 'psychiatrist', transcript);
 * const summary = await callAI(systemPrompt, userPrompt);
 */
```

3. Verify the complete integration compiles:
   - Import chain: ai-features.ts -> prompts/index.ts -> role prompt files
   - Type compatibility: TherapistRole flows through to getPromptForRole()
  </action>
  <verify>
`npm run build` passes (full build check)
No TypeScript errors in ai-features.ts
  </verify>
  <done>
ai-features.ts integrates with prompts/ directory; buildPromptFromSession() ready for Phase 2 AI integration; existing functionality preserved
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` passes
3. ai-features.ts imports from prompts/index.ts successfully
4. buildPromptFromSession() accepts Session, TherapistRole, optional transcript
5. formatSOAPNotes() extracts all SessionNotes fields
6. Existing generateSessionSummary() still works (backward compatible)
</verification>

<success_criteria>
- ai-features.ts uses getPromptForRole() to select prompts
- buildPromptFromSession() builds complete prompt from session data
- SOAP notes formatted with all available fields
- Transcript placeholder handled when empty
- Existing stub implementations preserved as fallback
- TypeScript compilation passes
- Ready for Phase 2 to add actual AI generation
</success_criteria>

<output>
After completion, create `.planning/phases/01-role-specific-prompts/01-02-SUMMARY.md`
</output>
