---
phase: 03-session-summary-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/index.ts
  - src/app/api/sessions/[id]/summary/route.ts
autonomous: true

must_haves:
  truths:
    - "Session type includes aiSummary field for persistence"
    - "PATCH /api/sessions/[id]/summary saves summary to session record"
    - "Saved summary persists in JSON storage and survives page reload"
  artifacts:
    - path: "src/types/index.ts"
      provides: "AISummary interface and Session.aiSummary field"
      contains: "aiSummary?: AISummary"
    - path: "src/app/api/sessions/[id]/summary/route.ts"
      provides: "PATCH handler for saving summaries"
      exports: ["POST", "GET", "PATCH"]
  key_links:
    - from: "src/app/api/sessions/[id]/summary/route.ts"
      to: "sessionRepository.update"
      via: "PATCH handler saves aiSummary to session"
      pattern: "sessionRepository\\.update.*aiSummary"
---

<objective>
Add persistence layer for AI-generated session summaries.

Purpose: Enable summaries to be saved to session records so they persist across page reloads and can be reviewed later. This is the data foundation for the generate/save/regenerate UI workflow.

Output: Extended Session type with aiSummary field, PATCH endpoint for saving summaries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 2 deliverables (already built)
@.planning/phases/02-session-summary-generation/02-02-SUMMARY.md

# Current implementations to extend
@src/types/index.ts
@src/app/api/sessions/[id]/summary/route.ts
@src/lib/data/repositories/base.repository.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Session type with aiSummary field</name>
  <files>src/types/index.ts</files>
  <action>
Add AISummary interface near other Session-related types (after SessionNotes, around line 97):

```typescript
export interface AISummary {
  content: string;           // The summary text
  generatedAt: Date;         // When generated
  mode: 'mock' | 'real';     // AI mode used
  model?: string;            // Model name (e.g., gpt-4o-mini)
  tokensUsed?: number;       // Tokens consumed (if real mode)
  savedAt?: Date;            // When approved/saved by therapist
  savedBy?: string;          // Therapist ID who approved
}
```

Add optional aiSummary field to Session interface (after signedBy, around line 70):

```typescript
aiSummary?: AISummary;
```

This captures the full lifecycle: generation metadata + approval metadata.
  </action>
  <verify>Run `npm run build` - no TypeScript errors. Grep for "aiSummary" in types/index.ts shows both the interface and the field.</verify>
  <done>AISummary interface exists with content, generatedAt, mode, model, tokensUsed, savedAt, savedBy fields. Session interface has optional aiSummary field.</done>
</task>

<task type="auto">
  <name>Task 2: Add PATCH endpoint to save summary</name>
  <files>src/app/api/sessions/[id]/summary/route.ts</files>
  <action>
Add PATCH handler to the existing summary route file (after GET handler):

```typescript
interface SaveSummaryRequest {
  summary: string;
  mode: 'mock' | 'real';
  model?: string;
  tokensUsed?: number;
  generatedAt: string;  // ISO string from POST response
}

/**
 * PATCH /api/sessions/[id]/summary
 *
 * Saves an AI-generated summary to the session record.
 * Called when therapist approves/saves a generated summary.
 *
 * Request body: SaveSummaryRequest
 * Response: Updated session with aiSummary field
 */
export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
): Promise<NextResponse> {
  try {
    const { id } = await params;
    const body: SaveSummaryRequest = await request.json();

    // Validate required fields
    if (!body.summary || !body.mode || !body.generatedAt) {
      return NextResponse.json(
        { error: 'Missing required fields: summary, mode, generatedAt' },
        { status: 400 }
      );
    }

    // Fetch session to verify it exists
    const session = await sessionRepository.findById(id);
    if (!session) {
      return NextResponse.json(
        { error: 'Session not found' },
        { status: 404 }
      );
    }

    // Build aiSummary object
    const aiSummary = {
      content: body.summary,
      generatedAt: new Date(body.generatedAt),
      mode: body.mode,
      model: body.model,
      tokensUsed: body.tokensUsed,
      savedAt: new Date(),
      // savedBy would come from auth context in real app
    };

    // Update session with aiSummary
    const updated = await sessionRepository.update(id, { aiSummary });

    return NextResponse.json({
      data: {
        sessionId: id,
        aiSummary: updated?.aiSummary,
        savedAt: aiSummary.savedAt.toISOString(),
      }
    });

  } catch (error) {
    console.error('Error saving summary:', error);
    return NextResponse.json(
      { error: 'Failed to save summary' },
      { status: 500 }
    );
  }
}
```

Import AISummary type if needed. The PATCH handler:
1. Validates required fields from POST response
2. Verifies session exists
3. Creates AISummary object with savedAt timestamp
4. Updates session via repository
5. Returns confirmation with saved summary
  </action>
  <verify>
1. `npm run build` passes
2. Test with curl:
   - First generate: `curl -X POST http://localhost:3000/api/sessions/session-1/summary`
   - Then save: `curl -X PATCH http://localhost:3000/api/sessions/session-1/summary -H "Content-Type: application/json" -d '{"summary":"Test summary","mode":"mock","generatedAt":"2026-01-22T00:00:00Z"}'`
   - Should return 200 with savedAt timestamp
  </verify>
  <done>PATCH /api/sessions/[id]/summary accepts summary data and saves to session.aiSummary field. Returns confirmation with savedAt timestamp.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npm run build`
2. AISummary interface and Session.aiSummary field exist in types
3. PATCH endpoint saves summary to session record
4. Saved summary persists in JSON storage (check data/sessions.json after PATCH)
</verification>

<success_criteria>
- Session type extended with aiSummary field
- PATCH /api/sessions/[id]/summary saves summary to session
- Summary data persists in JSON storage
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-session-summary-ui/03-01-SUMMARY.md`
</output>
