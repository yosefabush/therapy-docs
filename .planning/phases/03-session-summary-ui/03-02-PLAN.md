---
phase: 03-session-summary-ui
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/sessions/SummaryPanel.tsx
  - src/app/sessions/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Session page shows Generate Summary button when no summary exists"
    - "Generated summary appears for review before saving"
    - "Therapist can save/approve the generated summary"
    - "Saved summary displays with saved status indicator"
    - "Therapist can regenerate summary to get a fresh version"
  artifacts:
    - path: "src/components/sessions/SummaryPanel.tsx"
      provides: "AI summary generation UI component"
      min_lines: 100
    - path: "src/app/sessions/[id]/page.tsx"
      provides: "Session detail page with SummaryPanel integration"
      contains: "SummaryPanel"
  key_links:
    - from: "src/components/sessions/SummaryPanel.tsx"
      to: "POST /api/sessions/[id]/summary"
      via: "fetch call for generation"
      pattern: "fetch.*summary.*POST"
    - from: "src/components/sessions/SummaryPanel.tsx"
      to: "PATCH /api/sessions/[id]/summary"
      via: "fetch call for saving"
      pattern: "fetch.*summary.*PATCH"
    - from: "src/app/sessions/[id]/page.tsx"
      to: "src/components/sessions/SummaryPanel.tsx"
      via: "component import and render"
      pattern: "import.*SummaryPanel"
---

<objective>
Build the UI for generating, reviewing, saving, and regenerating AI summaries on the session page.

Purpose: Give therapists a complete workflow to get AI-generated summaries, review them before saving, and regenerate if needed. This is the user-facing feature that ties together the Phase 2 generation API and Phase 3 Plan 01 persistence.

Output: SummaryPanel component with full state machine (empty -> generating -> preview -> saved), integrated into session detail page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# This plan's dependency
@.planning/phases/03-session-summary-ui/03-01-SUMMARY.md

# Phase 2 API (already built)
@.planning/phases/02-session-summary-generation/02-02-SUMMARY.md

# Files to create/modify
@src/app/sessions/[id]/page.tsx
@src/components/ui/index.tsx

# Existing patterns
@src/lib/hooks/use-sessions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SummaryPanel component</name>
  <files>src/components/sessions/SummaryPanel.tsx</files>
  <action>
Create a new SummaryPanel component with these states:
- **empty**: No summary exists, show "Generate Summary" button
- **generating**: Loading state while API call in progress
- **preview**: Summary generated, show content with Save/Regenerate buttons
- **saved**: Summary saved, show content with Regenerate button and saved badge
- **error**: Generation failed, show error with retry option

Props interface:
```typescript
interface SummaryPanelProps {
  sessionId: string;
  existingSummary?: AISummary | null;  // From session.aiSummary
  hasNotes: boolean;  // Whether session has subjective notes (required for generation)
  onSummarySaved?: () => void;  // Callback after save (for parent to refetch)
}
```

Implementation notes:
- Use useState for: state ('empty'|'generating'|'preview'|'saved'|'error'), summary content, error message, generation metadata (mode, model, tokensUsed, generatedAt)
- Initialize state based on existingSummary prop (if exists, start in 'saved' state)
- POST /api/sessions/{sessionId}/summary for generation
- PATCH /api/sessions/{sessionId}/summary for saving
- Use existing UI components: Card, Button, Badge from @/components/ui
- Style with Tailwind matching existing AI summary card (bg-gradient-to-br from-sage-50 to-warm-50)
- Hebrew labels: "יצירת סיכום" (Generate Summary), "שמירה" (Save), "יצירה מחדש" (Regenerate), "סיכום AI נשמר" (AI Summary Saved)
- Show mode badge: "מצב בדיקה" for mock, "AI" for real mode
- Display generatedAt timestamp in Hebrew locale
- If hasNotes is false, show disabled button with tooltip "יש להוסיף תיעוד מפגש תחילה"

Error handling:
- If generation fails (400/500), show error message with "נסה שוב" (Try Again) button
- If save fails, show error but keep summary in preview state

Component structure:
```tsx
'use client';

import React, { useState, useEffect } from 'react';
import { Card, Button, Badge } from '@/components/ui';
import { AISummary } from '@/types';

type PanelState = 'empty' | 'generating' | 'preview' | 'saved' | 'error';

// ... implementation
```
  </action>
  <verify>
1. File exists at src/components/sessions/SummaryPanel.tsx
2. `npm run build` passes
3. Component exports SummaryPanel
4. Grep shows state machine states: 'empty', 'generating', 'preview', 'saved', 'error'
  </verify>
  <done>SummaryPanel component exists with full state machine: empty (generate button), generating (loading), preview (save/regenerate), saved (regenerate only), error (retry). Uses POST for generation, PATCH for saving.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate SummaryPanel into session page</name>
  <files>src/app/sessions/[id]/page.tsx</files>
  <action>
Replace the existing static AI summary display with the new SummaryPanel component:

1. Add import at top:
```typescript
import { SummaryPanel } from '@/components/sessions/SummaryPanel';
```

2. Remove the old aiSummary generation (around line 55):
```typescript
// DELETE THIS LINE:
const aiSummary = session.status === 'completed' ? generateSessionSummary(session, session.therapistRole) : null;
```

3. Remove the import for generateSessionSummary if no longer used elsewhere.

4. Replace the existing AI Summary Card (lines 173-184) with SummaryPanel:
```tsx
{/* AI Summary */}
{session.status === 'completed' && (
  <SummaryPanel
    sessionId={session.id}
    existingSummary={session.aiSummary}
    hasNotes={Boolean(session.notes.subjective)}
    onSummarySaved={() => {
      // Refetch session to get updated aiSummary
      // The useSession hook doesn't have refetch, so we'll use router.refresh()
      router.refresh();
    }}
  />
)}
```

The SummaryPanel handles:
- Showing "Generate Summary" button when session.aiSummary is undefined
- Showing saved summary when session.aiSummary exists
- All generate/preview/save/regenerate workflow

Note: Only show SummaryPanel for completed sessions (status === 'completed'). Scheduled/in-progress sessions don't need summaries yet.
  </action>
  <verify>
1. `npm run build` passes
2. Session page imports SummaryPanel
3. No more static generateSessionSummary call for aiSummary
4. SummaryPanel rendered conditionally for completed sessions
5. Manual test: Visit a completed session page, see "Generate Summary" button
  </verify>
  <done>Session detail page uses SummaryPanel component. Completed sessions show generate/preview/save/regenerate workflow. No static summary generation.</done>
</task>

<task type="auto">
  <name>Task 3: Add refetch capability to useSession hook</name>
  <files>src/lib/hooks/use-sessions.ts</files>
  <action>
The useSession hook currently doesn't expose a refetch function. Add it for the onSummarySaved callback:

In the useSession function, extract the fetch logic to a useCallback and expose it:

```typescript
export function useSession(id: string) {
  const [session, setSession] = useState<Session | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const fetchSession = useCallback(async () => {
    if (!id) {
      setLoading(false);
      setSession(null);
      return;
    }

    setLoading(true);
    try {
      const response = await apiClient.get<Session>(`/sessions/${id}`);
      if (response.error) {
        setError(response.error);
      } else {
        setSession(response.data ?? null);
      }
    } catch (err) {
      setError('Failed to fetch session');
    } finally {
      setLoading(false);
    }
  }, [id]);

  useEffect(() => {
    fetchSession();
  }, [fetchSession]);

  return { session, loading, error, refetch: fetchSession };
}
```

Add useCallback import if not present.

Then update session page to use refetch:
```tsx
const { session, loading: sessionLoading, refetch: refetchSession } = useSession(sessionId);

// In SummaryPanel props:
onSummarySaved={() => refetchSession()}
```
  </action>
  <verify>
1. `npm run build` passes
2. useSession returns { session, loading, error, refetch }
3. Session page uses refetch in onSummarySaved callback
  </verify>
  <done>useSession hook exposes refetch function. Session page calls refetch after summary is saved to update the displayed session data.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build`
2. SummaryPanel component exists with proper state machine
3. Session page integrates SummaryPanel for completed sessions
4. useSession hook has refetch capability
5. End-to-end flow works:
   - Visit completed session page
   - Click "Generate Summary"
   - See loading state
   - See generated summary with Save/Regenerate buttons
   - Click Save
   - See saved state with Regenerate button
   - Page reload shows saved summary
</verification>

<success_criteria>
- Session page shows "Generate Summary" button when no summary exists (SUMM-02 partial)
- Generated summary appears for review before saving (SUMM-05)
- Therapist can save the summary (SUMM-06)
- Saved summary persists across page reloads (SUMM-06)
- Therapist can regenerate summary (SUMM-07)
- Summary displays above SOAP notes (SUMM-02)
</success_criteria>

<output>
After completion, create `.planning/phases/03-session-summary-ui/03-02-SUMMARY.md`
</output>
