---
phase: 05-patient-insight-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/patients/InsightPanel.tsx
  - src/app/patients/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Patient profile page shows 'Generate Insights' button in overview section"
    - "Clicking button triggers insight generation (shows loading state)"
    - "Generated insights appear in preview state with Save/Regenerate options"
    - "Therapist can see insight categories (patterns, progress, risks, gaps)"
    - "Therapist can regenerate to get updated insights"
  artifacts:
    - path: "src/components/patients/InsightPanel.tsx"
      provides: "Insight generation UI with state machine"
      min_lines: 150
    - path: "src/app/patients/[id]/page.tsx"
      provides: "Patient page with InsightPanel integrated"
      contains: "InsightPanel"
  key_links:
    - from: "src/components/patients/InsightPanel.tsx"
      to: "/api/patients/[id]/insights"
      via: "fetch in handleGenerate"
      pattern: "fetch.*api/patients.*insights"
    - from: "src/app/patients/[id]/page.tsx"
      to: "src/components/patients/InsightPanel.tsx"
      via: "import and render"
      pattern: "import.*InsightPanel"
---

<objective>
Create InsightPanel component for patient profile page that triggers AI insight generation

Purpose: Enable therapists to generate AI insights directly from patient profile (INSI-01)
Output: InsightPanel component integrated into patient profile overview section
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/sessions/SummaryPanel.tsx
@src/app/patients/[id]/page.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InsightPanel component</name>
  <files>src/components/patients/InsightPanel.tsx</files>
  <action>
Create InsightPanel.tsx following the SummaryPanel pattern with these specifications:

**State Machine (5 states):**
- `empty`: No insights exist, show "Generate Insights" button
- `generating`: Loading spinner with "Generating insights..."
- `preview`: Show insights with Save/Regenerate buttons (unsaved badge)
- `saved`: Show insights with Regenerate button only (saved badge)
- `error`: Show error message with Retry button

**Props Interface:**
```typescript
interface InsightPanelProps {
  patientId: string;
  patientName: string;
  existingInsights?: PatientInsights | null;
  onInsightsSaved?: () => void;
}
```

**API Integration - handleGenerate function:**
```typescript
const handleGenerate = async () => {
  setState('generating');
  setError(null);

  try {
    const response = await fetch(`/api/patients/${patientId}/insights`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    const result = await response.json();

    // Handle error response
    if (!response.ok || result.error) {
      setError(result.error || `Failed to generate insights (${response.status})`);
      setState('error');
      return;
    }

    // Handle success - response format: { data: PatientInsights }
    if (result.data) {
      setInsights(result.data);
      setState('preview');
    } else {
      setError('Invalid response format from server');
      setState('error');
    }
  } catch (err) {
    console.error('Insight generation failed:', err);
    setError('Network error - could not connect to server');
    setState('error');
  }
};
```

**Regenerate handler (reuses handleGenerate):**
```typescript
const handleRegenerate = () => {
  // Clear current insights and regenerate
  handleGenerate();
};
```

**Display Structure:**
For each category (patterns, progressTrends, riskIndicators, treatmentGaps):
- Show category header with icon and count badge
- List insight items with confidence indicator
- Confidence display: High (90%+) = green, Medium (70-89%) = yellow, Low (<70%) = gray
- Show session references if available

**Hebrew Labels:**
- patterns: "דפוסים"
- progressTrends: "מגמות התקדמות"
- riskIndicators: "מדדי סיכון"
- treatmentGaps: "פערים בטיפול"
- Generate button: "יצירת תובנות"
- Save button: "שמירה"
- Regenerate button: "יצירה מחדש"

**Styling:**
- Use Card component with sage/warm gradient background (same as SummaryPanel)
- Use Badge component for mode/status indicators
- Use AI lightbulb icon (same as SummaryPanel header)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Component exists at src/components/patients/InsightPanel.tsx
- Component exports InsightPanel function
  </verify>
  <done>
InsightPanel component exists with state machine, API integration, and insight display
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate InsightPanel into patient profile</name>
  <files>src/app/patients/[id]/page.tsx</files>
  <action>
Modify the patient detail page to include InsightPanel:

1. **Import:**
   ```typescript
   import { InsightPanel } from '@/components/patients/InsightPanel';
   ```

2. **Placement:**
   Add InsightPanel to the overview tab, in the sidebar info section (right column).
   Place it below the "Care Team" card, before closing the right column div.

3. **Props:**
   ```tsx
   <InsightPanel
     patientId={patient.id}
     patientName={`${patient.firstName} ${patient.lastName}`}
   />
   ```

Note: existingInsights prop will be added in Plan 03 when persistence is implemented.
For now, the panel starts in `empty` state each time.

4. **Conditional rendering:**
   Show InsightPanel only when patient has at least one completed session.
   Use the existing `completedSessions` variable: `{completedSessions.length > 0 && <InsightPanel ... />}`
  </action>
  <verify>
- `npm run build` passes
- Patient profile page shows InsightPanel in overview tab sidebar
- InsightPanel only appears when patient has completed sessions
  </verify>
  <done>
InsightPanel integrated into patient profile page overview section
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify end-to-end generation flow</name>
  <what-built>InsightPanel component integrated into patient profile with AI insight generation</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to patient profile with completed sessions (e.g., /patients/patient-1)
3. Verify InsightPanel appears in overview tab sidebar
4. Click "Generate Insights" button
5. Verify loading state appears ("Generating insights...")
6. Verify insights display in preview state with:
   - Four category sections (patterns, progress, risks, gaps)
   - Insight items with confidence indicators
   - Save and Regenerate buttons
   - "Unsaved" badge
7. Click Regenerate to verify it generates new insights
8. Optionally test error handling: disconnect network, click Generate, verify error state with Retry button
  </how-to-verify>
  <resume-signal>Type "approved" if insights generate and display correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` succeeds
- [ ] InsightPanel component exists with proper state machine
- [ ] Patient profile page imports and renders InsightPanel
- [ ] Generate button calls POST /api/patients/[id]/insights
- [ ] Insights display with 4 categories and confidence indicators
- [ ] Regenerate button triggers new generation
- [ ] Hebrew labels used throughout
</verification>

<success_criteria>
Patient profile page shows "Generate Insights" button that triggers insight generation and displays results in preview state (INSI-01 satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/05-patient-insight-integration/05-01-SUMMARY.md`
</output>
