---
phase: 05-patient-insight-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/insights/page.tsx
  - src/components/insights/PatientInsightCard.tsx
autonomous: true

must_haves:
  truths:
    - "AI insights page shows real PatientInsights data (not mock analyzePatternsTrends)"
    - "User can select a patient to view their insights"
    - "Insights display 4 categories with proper formatting"
    - "Empty state shows when patient has no generated insights"
  artifacts:
    - path: "src/components/insights/PatientInsightCard.tsx"
      provides: "Reusable insight category display component"
      min_lines: 80
    - path: "src/app/insights/page.tsx"
      provides: "Enhanced insights page with patient selector"
      contains: "PatientInsightCard"
  key_links:
    - from: "src/app/insights/page.tsx"
      to: "/api/patients/[id]/insights"
      via: "fetch on patient select"
      pattern: "fetch.*api/patients.*insights"
    - from: "src/app/insights/page.tsx"
      to: "src/components/insights/PatientInsightCard.tsx"
      via: "import and render"
      pattern: "import.*PatientInsightCard"
---

<objective>
Enhance AI insights page to display PatientInsights from API with patient selection

Purpose: Display AI-generated insights on dedicated insights page (INSI-07)
Output: Insights page showing real PatientInsights data with patient selector
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/insights/page.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PatientInsightCard component</name>
  <files>src/components/insights/PatientInsightCard.tsx</files>
  <action>
Create a reusable component for displaying insight categories.

**Props Interface:**
```typescript
interface PatientInsightCardProps {
  title: string;
  icon: React.ReactNode;
  items: InsightItem[];
  emptyMessage?: string;
  variant: 'pattern' | 'progress' | 'risk' | 'gap';
}
```

**Display:**
- Card with colored header based on variant:
  - pattern: blue (bg-blue-50, border-blue-200)
  - progress: green (bg-green-50, border-green-200)
  - risk: red (bg-red-50, border-red-200)
  - gap: amber (bg-amber-50, border-amber-200)
- Title with icon and item count badge
- List of insight items with:
  - Confidence bar/indicator (visual bar + percentage)
  - Content text
  - Session references if available (as subtle links/badges)
  - First/last seen dates for progress trends

**Confidence Display:**
```typescript
const getConfidenceColor = (confidence: number) => {
  if (confidence >= 0.9) return 'bg-green-500';
  if (confidence >= 0.7) return 'bg-yellow-500';
  return 'bg-gray-400';
};
```

**Empty State:**
If items array is empty, show emptyMessage or default "No insights in this category"

Create directory if needed: `src/components/insights/`
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Component exists at src/components/insights/PatientInsightCard.tsx
- Component handles empty state
  </verify>
  <done>
PatientInsightCard component exists with variant styling and confidence display
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance insights page with patient selector</name>
  <files>src/app/insights/page.tsx</files>
  <action>
Refactor the insights page to use real PatientInsights data:

**State:**
```typescript
const [selectedPatientId, setSelectedPatientId] = useState<string | null>(null);
const [insights, setInsights] = useState<PatientInsights | null>(null);
const [insightsLoading, setInsightsLoading] = useState(false);
const [insightsError, setInsightsError] = useState<string | null>(null);
```

**Patient Selector:**
Add a select dropdown above the stats section:
```tsx
<div className="mb-6">
  <label className="block text-sm font-medium text-clinical-700 mb-2">
    בחר מטופל לצפייה בתובנות
  </label>
  <select
    value={selectedPatientId || ''}
    onChange={(e) => setSelectedPatientId(e.target.value || null)}
    className="w-full max-w-md px-4 py-2.5 rounded-lg border border-sage-200..."
  >
    <option value="">בחר מטופל...</option>
    {myPatients.map(p => (
      <option key={p.id} value={p.id}>
        {p.firstName} {p.lastName}
      </option>
    ))}
  </select>
</div>
```

**Fetch Insights on Selection:**
```typescript
useEffect(() => {
  if (!selectedPatientId) {
    setInsights(null);
    return;
  }

  const fetchInsights = async () => {
    setInsightsLoading(true);
    setInsightsError(null);
    try {
      const response = await fetch(`/api/patients/${selectedPatientId}/insights`, {
        method: 'POST',
      });
      const result = await response.json();
      if (result.error) {
        setInsightsError(result.error);
      } else {
        setInsights(result.data);
      }
    } catch {
      setInsightsError('Failed to fetch insights');
    } finally {
      setInsightsLoading(false);
    }
  };

  fetchInsights();
}, [selectedPatientId]);
```

**Replace Stats Section:**
Update stats to show counts from selected patient's insights (or zeros if none):
- Risk alerts: `insights?.riskIndicators.length || 0`
- Progress trends: `insights?.progressTrends.length || 0`
- Patterns: `insights?.patterns.length || 0`
- Treatment gaps: `insights?.treatmentGaps.length || 0`

**Replace Insights List:**
Remove the old `analyzePatternsTrends` usage. Instead:
- If no patient selected: Show "Select a patient to view insights"
- If loading: Show loading spinner
- If error: Show error message
- If insights: Show 4 PatientInsightCard components:

```tsx
<div className="grid grid-cols-1 md:grid-cols-2 gap-6">
  <PatientInsightCard
    title="דפוסים"
    icon={/* pattern icon */}
    items={insights.patterns}
    variant="pattern"
  />
  <PatientInsightCard
    title="מגמות התקדמות"
    icon={/* trend icon */}
    items={insights.progressTrends}
    variant="progress"
  />
  <PatientInsightCard
    title="מדדי סיכון"
    icon={/* warning icon */}
    items={insights.riskIndicators}
    variant="risk"
  />
  <PatientInsightCard
    title="פערים בטיפול"
    icon={/* gap icon */}
    items={insights.treatmentGaps}
    variant="gap"
  />
</div>
```

**Remove Old Code:**
- Remove import of `analyzePatternsTrends` from '@/lib/ai-features'
- Remove `allInsights`, `riskInsights`, `progressInsights`, `patternInsights` variables
- Remove tabs filtering logic (keep tabs but update counts from insights)
- Remove old insight card rendering

**Keep:**
- Sidebar, Header layout
- Stats card grid (update values from insights)
- General page structure
  </action>
  <verify>
- `npm run build` passes
- Patient selector dropdown renders
- Selecting patient fetches and displays insights
- 4 insight categories display correctly
- Stats update based on selected patient's insights
  </verify>
  <done>
Insights page shows real PatientInsights from API with patient selector
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` succeeds
- [ ] PatientInsightCard component exists with variant styling
- [ ] Insights page has patient selector dropdown
- [ ] Selecting patient calls POST /api/patients/[id]/insights
- [ ] Insights display in 4 category cards
- [ ] Empty state shows when no patient selected
- [ ] Loading state shows during fetch
</verification>

<success_criteria>
AI insights page displays PatientInsights from API with patient selector allowing therapists to view insights for any patient (INSI-07 satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/05-patient-insight-integration/05-02-SUMMARY.md`
</output>
