---
phase: 05-patient-insight-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/insights/page.tsx
  - src/components/insights/PatientInsightCard.tsx
autonomous: true

must_haves:
  truths:
    - "AI insights page shows real PatientInsights data (not mock analyzePatternsTrends)"
    - "User can select a patient to view their insights"
    - "Insights display 4 categories with proper formatting"
    - "Empty state shows when patient has no generated insights"
    - "User can regenerate insights from insights page"
  artifacts:
    - path: "src/components/insights/PatientInsightCard.tsx"
      provides: "Reusable insight category display component"
      min_lines: 80
    - path: "src/app/insights/page.tsx"
      provides: "Enhanced insights page with patient selector"
      contains: "PatientInsightCard"
  key_links:
    - from: "src/app/insights/page.tsx"
      to: "/api/patients/[id]/insights"
      via: "fetch on patient select"
      pattern: "fetch.*api/patients.*insights"
    - from: "src/app/insights/page.tsx"
      to: "src/components/insights/PatientInsightCard.tsx"
      via: "import and render"
      pattern: "import.*PatientInsightCard"
---

<objective>
Enhance AI insights page to display PatientInsights from API with patient selection

Purpose: Display AI-generated insights on dedicated insights page (INSI-07)
Output: Insights page showing real PatientInsights data with patient selector
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/insights/page.tsx
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PatientInsightCard component</name>
  <files>src/components/insights/PatientInsightCard.tsx</files>
  <action>
Create a reusable component for displaying insight categories.

**Props Interface:**
```typescript
interface PatientInsightCardProps {
  title: string;
  icon: React.ReactNode;
  items: InsightItem[];
  emptyMessage?: string;
  variant: 'pattern' | 'progress' | 'risk' | 'gap';
}
```

**Display:**
- Card with colored header based on variant:
  - pattern: blue (bg-blue-50, border-blue-200)
  - progress: green (bg-green-50, border-green-200)
  - risk: red (bg-red-50, border-red-200)
  - gap: amber (bg-amber-50, border-amber-200)
- Title with icon and item count badge
- List of insight items with:
  - Confidence bar/indicator (visual bar + percentage)
  - Content text
  - Session references if available (as subtle links/badges)
  - First/last seen dates for progress trends

**Confidence Display:**
```typescript
const getConfidenceColor = (confidence: number) => {
  if (confidence >= 0.9) return 'bg-green-500';
  if (confidence >= 0.7) return 'bg-yellow-500';
  return 'bg-gray-400';
};
```

**Empty State:**
If items array is empty, show emptyMessage or default "No insights in this category"

Create directory if needed: `src/components/insights/`
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Component exists at src/components/insights/PatientInsightCard.tsx
- Component handles empty state
  </verify>
  <done>
PatientInsightCard component exists with variant styling and confidence display
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance insights page with patient selector</name>
  <files>src/app/insights/page.tsx</files>
  <action>
Refactor the insights page to use real PatientInsights data:

**State:**
```typescript
const [selectedPatientId, setSelectedPatientId] = useState<string | null>(null);
const [insights, setInsights] = useState<PatientInsights | null>(null);
const [insightsLoading, setInsightsLoading] = useState(false);
const [insightsError, setInsightsError] = useState<string | null>(null);
```

**Patient Selector:**
Add a select dropdown above the stats section:
```tsx
<div className="mb-6">
  <label className="block text-sm font-medium text-clinical-700 mb-2">
    בחר מטופל לצפייה בתובנות
  </label>
  <select
    value={selectedPatientId || ''}
    onChange={(e) => setSelectedPatientId(e.target.value || null)}
    className="w-full max-w-md px-4 py-2.5 rounded-lg border border-sage-200..."
  >
    <option value="">בחר מטופל...</option>
    {myPatients.map(p => (
      <option key={p.id} value={p.id}>
        {p.firstName} {p.lastName}
      </option>
    ))}
  </select>
</div>
```

**Fetch Insights - Complete Implementation:**
```typescript
// Fetch insights when patient selected
const fetchInsights = async (patientId: string) => {
  setInsightsLoading(true);
  setInsightsError(null);

  try {
    const response = await fetch(`/api/patients/${patientId}/insights`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    const result = await response.json();

    // Handle error response from API
    if (!response.ok || result.error) {
      setInsightsError(result.error || `Server error (${response.status})`);
      setInsights(null);
      return;
    }

    // Handle success - response format: { data: PatientInsights }
    if (result.data) {
      setInsights(result.data);
    } else {
      setInsightsError('Invalid response format');
      setInsights(null);
    }
  } catch (err) {
    console.error('Failed to fetch insights:', err);
    setInsightsError('Network error - could not connect to server');
    setInsights(null);
  } finally {
    setInsightsLoading(false);
  }
};

// Trigger fetch on patient selection
useEffect(() => {
  if (!selectedPatientId) {
    setInsights(null);
    setInsightsError(null);
    return;
  }

  fetchInsights(selectedPatientId);
}, [selectedPatientId]);

// Regenerate handler (for "Regenerate" button)
const handleRegenerate = () => {
  if (selectedPatientId) {
    fetchInsights(selectedPatientId);
  }
};
```

**Replace Stats Section:**
Update stats to show counts from selected patient's insights (or zeros if none):
- Risk alerts: `insights?.riskIndicators.length || 0`
- Progress trends: `insights?.progressTrends.length || 0`
- Patterns: `insights?.patterns.length || 0`
- Treatment gaps: `insights?.treatmentGaps.length || 0`

**Replace Insights List:**
Remove the old `analyzePatternsTrends` usage. Instead show state-based content:

```tsx
{/* No patient selected */}
{!selectedPatientId && (
  <div className="text-center py-12 text-clinical-500">
    <p>בחר מטופל לצפייה בתובנות</p>
  </div>
)}

{/* Loading state */}
{selectedPatientId && insightsLoading && (
  <div className="text-center py-12">
    <div className="animate-spin h-8 w-8 border-4 border-sage-500 border-t-transparent rounded-full mx-auto mb-4" />
    <p className="text-clinical-600">מייצר תובנות...</p>
  </div>
)}

{/* Error state with retry */}
{selectedPatientId && insightsError && !insightsLoading && (
  <div className="text-center py-12">
    <p className="text-red-600 mb-4">{insightsError}</p>
    <button
      onClick={handleRegenerate}
      className="px-4 py-2 bg-sage-600 text-white rounded-lg hover:bg-sage-700"
    >
      נסה שוב
    </button>
  </div>
)}

{/* Insights display */}
{selectedPatientId && insights && !insightsLoading && (
  <>
    <div className="flex justify-end mb-4">
      <button
        onClick={handleRegenerate}
        className="px-4 py-2 text-sage-700 border border-sage-300 rounded-lg hover:bg-sage-50"
      >
        יצירה מחדש
      </button>
    </div>
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      <PatientInsightCard
        title="דפוסים"
        icon={/* pattern icon */}
        items={insights.patterns}
        variant="pattern"
      />
      <PatientInsightCard
        title="מגמות התקדמות"
        icon={/* trend icon */}
        items={insights.progressTrends}
        variant="progress"
      />
      <PatientInsightCard
        title="מדדי סיכון"
        icon={/* warning icon */}
        items={insights.riskIndicators}
        variant="risk"
      />
      <PatientInsightCard
        title="פערים בטיפול"
        icon={/* gap icon */}
        items={insights.treatmentGaps}
        variant="gap"
      />
    </div>
  </>
)}
```

**Remove Old Code:**
- Remove import of `analyzePatternsTrends` from '@/lib/ai-features'
- Remove `allInsights`, `riskInsights`, `progressInsights`, `patternInsights` variables
- Remove tabs filtering logic (keep tabs but update counts from insights)
- Remove old insight card rendering

**Keep:**
- Sidebar, Header layout
- Stats card grid (update values from insights)
- General page structure
  </action>
  <verify>
- `npm run build` passes
- Patient selector dropdown renders
- Selecting patient fetches and displays insights
- 4 insight categories display correctly
- Stats update based on selected patient's insights
- Regenerate button refetches insights
- Error state shows with retry option
  </verify>
  <done>
Insights page shows real PatientInsights from API with patient selector
  </done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit` passes with no errors
- [ ] `npm run build` succeeds
- [ ] PatientInsightCard component exists with variant styling
- [ ] Insights page has patient selector dropdown
- [ ] Selecting patient calls POST /api/patients/[id]/insights
- [ ] Insights display in 4 category cards
- [ ] Empty state shows when no patient selected
- [ ] Loading state shows during fetch
- [ ] Error state shows with retry button
- [ ] Regenerate button triggers new generation
</verification>

<success_criteria>
AI insights page displays PatientInsights from API with patient selector allowing therapists to view insights for any patient (INSI-07 satisfied)
</success_criteria>

<output>
After completion, create `.planning/phases/05-patient-insight-integration/05-02-SUMMARY.md`
</output>
